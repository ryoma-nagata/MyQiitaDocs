## はじめに

SharePoint（Teamsも含む） 上のファイル連携の要望は多いです。

[Azure Data FactoryでSharePointのファイルをADLS Gen2にコピー](https://qiita.com/yaagi/items/eb6a86e0c9a2fc3b3e61) など、API を利用したコピーはいくつか見かけられますが、 基本的には 単一ファイルをループしてとるような方式です。

今回はより簡単な方法のアイデアをもらったのでやってみました。

※ 今回紹介する方法は一つの手段であり、懸念も存在します。個人的には保証されている API を利用したほうがデータ連携としては安定するように思います。ただ、API の方式は大量のファイル連携でもいけるのか？という気持ち・・・

## 概要

SharePoint の Onedrive を利用したローカルファイル同期を使ってファイルシステムとして セルフホステッド統合ランタイムからアクセスさせます。

## 手順

ローカルファイルへアクセスするためのリンクサービス設定は[こちら](https://qiita.com/ryoma-nagata/items/35e58aa4bb846bd8dac3)をご確認ください。


### 1. ローカルファイル同期設定

1. SharePoint or Teams の 対象フォルダを同期します。

![](.image/2023-02-21-09-28-21.png)

2. フォルダが追加されたら右クリックから **このデバイス上で常に保持** をクリック

![](.image/2023-02-21-09-29-30.png)

### 2. パイプライン作成

1. パイプライン画面からファイルシステムのデータセットを作成します。

![](.image/2023-02-21-09-30-43.png)

![](.image/2023-02-21-09-31-23.png)

2. ファイルパスを確認し、参照します

![](.image/2023-02-21-09-31-50.png)

![](.image/2023-02-21-09-42-51.png)


3. データセットが完成しました。

![](.image/2023-02-21-09-42-59.png)

4. コピーアクティビティのパイプラインを作成し、適当な場所にシンクする設定をします。

![](.image/2023-02-21-09-32-58.png)

![](.image/2023-02-21-09-33-25.png)

### 3. 確認

1. ファイルを Teams にアップしてみます。ルートフォルダはOnedriveが使用しているファイルがあるためお勧めしません。

![](.image/2023-02-21-09-40-08.png)

2. 数分待ち、パイプラインをデバッグ実行し、成功を確認します

![](.image/2023-02-21-09-35-56.png)

3. データレイクに連携できました。

![](.image/2023-02-21-09-41-07.png)

## 懸念

- ファイル同期のラグが発生するため、アップしたファイルはすぐに取得できません。
- 今回の検証の中ではユーザーのロック状態でも取得できることを確認できていますが、同期のタイミングや、不整合を起こした際に同期が停止するようなことが起きたら、など実際運用してみないとわからないことがありそうです。


